
---
title: "Statistical Analysis of Player Behaviour in Online Poker"
author: "Roman Prokhorov, Maksym Holovin, Nazar Pasichnyk"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE,
  fig.width = 8, fig.height = 5
)

# Install gridExtra if not already installed
if (!require("gridExtra", quietly = TRUE)) {
  install.packages("gridExtra", repos = "https://cran.rstudio.com/")
}

library(ggplot2)
library(dplyr)
library(knitr)
library(gridExtra)
```

```{r load_data, include=FALSE}
# Load all datasets
demographics <- read.csv("csv/Demographics.csv")
cash_games <- read.csv("csv/CashGames.csv")
tournaments <- read.csv("csv/Tournaments.csv")
deposits <- read.csv("csv/Deposits.csv")
withdrawals <- read.csv("csv/Withdrawals.csv")

# Load country codes from ISO 3166-1 standard
raw_data <- read.csv(
  paste0(
    "https://raw.githubusercontent.com/lukes/",
    "ISO-3166-Countries-with-Regional-Codes/",
    "master/all/all.csv"
  ),
  stringsAsFactors = FALSE
)

# Create Nations lookup table
nations <- data.frame(
  Number = raw_data$country.code, NameEN = raw_data$name,
  Char2 = raw_data$alpha.2, Char3 = raw_data$alpha.3,
  stringsAsFactors = FALSE
)

# Apply GVC-specific corrections (as noted in data documentation)
nations$NameEN[nations$Number == 626] <- "East Timor"
nations$Char2[nations$Number == 626] <- "TP"
nations$Char3[nations$Number == 626] <- "TMP"
nations$Char3[nations$Number == 620] <- "POR"
nations$Char3[nations$Number == 642] <- "ROM"
nations$Char3[nations$Number == 756] <- "SUI"
nations$NameEN[nations$Number == 248] <- "Aland Islands"

# Add "Undefined" category
nations <- rbind(
  nations,
  data.frame(
    Number = 1000, NameEN = "Undefined",
    Char2 = "UD", Char3 = "UND",
    stringsAsFactors = FALSE
  )
)

# Merge country names with demographics
demographics <- demographics %>%
  left_join(nations, by = c("CountryID" = "Number")) %>%
  rename(Country = NameEN)
```

## 1\. Research Topic

We aim to analyze patterns in online poker player behavior using real transaction and gameplay data.
Our study will examine relationships between player demographics, betting patterns, and financial outcomes to understand
different player types and their gambling strategies.

## 2\. Data Source

**Source:** The Transparency Project (www.thetransparencyproject.org)

**Provider:** Division on Addiction, Cambridge Health Alliance, Harvard Medical School

**Dataset:** "Second Session at the Virtual Poker Table"

**Sample Size:** 5,028 online poker players who registered in February 2015

**Reference:** Tom, M. A., et al. (2022). Second Session at the Virtual Poker Table: A Contemporary Study of Actual Online Poker Activity. *Journal of Gambling Studies*. https://doi.org/10.1007/s10899-022-10147-1

## 3\. Data Description

The dataset consists of five interconnected CSV files:

  - **Demographics** (5,028 players): Age, Gender, Country of residence (encoded using ISO 3166-1 country codes)

  - **Cash Games** (51,763 daily records): Stakes wagered, winnings, number of sessions

  - **Tournaments** (82,831 daily records): Entry fees, prizes, number of tournaments

  - **Deposits** (295,119 transactions): Amount, payment method, transaction status

  - **Withdrawals** (32,307 transactions): Amount, payment method, transaction status

Key variables include player demographics, daily gambling activity (stakes and winnings),
and financial transactions (deposits and withdrawals in Euros). Country information is mapped from numeric ISO 3166-1 codes to country names for analysis.

### Sample Data Structure

```{r data_samples}
# Demographics sample - show with country names
kable(
  head(
    demographics[, c("UserID", "SystemAgeAsOfReg", "Gender", "Country")],
    5
  ),
  caption = "Demographics Sample (with Country Names)",
  col.names = c("User ID", "Age", "Gender", "Country")
)

# Deposits sample
kable(
  head(deposits[, c("UserID", "Amount", "Status", "PayMeth")], 5),
  caption = "Deposits Sample",
  col.names = c("User ID", "Amount (€)", "Status", "Payment Method")
)

# Cash Games sample
kable(
  head(cash_games, 5), caption = "Cash Games Sample",
  col.names = c("User ID", "Date", "Sessions", "Stakes (€)", "Winnings (€)")
)

# Top 10 countries by player count
top_countries <- demographics %>%
  filter(!is.na(Country)) %>%
  count(Country, sort = TRUE) %>%
  head(10)

kable(
  top_countries, caption = "Top 10 Countries by Player Count",
  col.names = c("Country", "Number of Players")
)
```


## 4. Preliminary Hypotheses (Revised $\beta_0$ Explanation)

### Hypothesis 1 (Two-Sample T-Test)

**Research Question:** Is there a significant difference in the mean total stakes wagered between players who bet frequently (High-Frequency) and players who bet infrequently (Low-Frequency)?

We define two groups based on the median number of bets:

- **Group 1 (Low-Frequency Bettors):** Players with a number of bets below the median ($\mu_{low}$)
- **Group 2 (High-Frequency Bettors):** Players with a number of bets at or above the median ($\mu_{high}$)

The T-test compares the mean total stakes ($Y$) between these two population groups.

* **$H_0$ (Null Hypothesis):** $\mu_{high} = \mu_{low}$. The mean total stakes is the same for both groups.
* **$H_a$ (Alternative Hypothesis):** $\mu_{high} > \mu_{low}$. High-Frequency bettors have a significantly higher mean total stakes than Low-Frequency bettors.

---

### Hypothesis 2 (Multiple Linear Regression)

**Research Question:** Do demographic characteristics (Age and Gender) predict the total amount a player wagers?

We define $Y$ as the Total Stakes Wagered, $X_1$ as Age, and $X_2$ as Gender (encoded as 0 for Female, 1 for Male). The model is:

$$Y = \beta_0 + \beta_1(Age) + \beta_2(Gender) + \epsilon$$

Where:

* **$\beta_0$ (Y-Intercept):** Mathematically, this is the predicted total stakes (€) when all predictor variables are zero (Age=0, Gender=0). Since a 0-year-old cannot gamble, this term provides no practical interpretation and should be understood only as the necessary constant to align the fitted model with the observed data.
* **$\beta_1$ (Age Coefficient):** The change in total stakes for every one-year increase in age, holding gender constant.
* **$\beta_2$ (Gender Coefficient):** The difference in total stakes between male players and the baseline female players (when controlling for age).
* **$\epsilon$ (Error Term):** The unexplained variation in total stakes not accounted for by Age and Gender.

* **$H_0$ (Null Hypothesis):** $\beta_1 = 0$ and $\beta_2 = 0$. Age and Gender have no linear relationship with total stakes wagered.
* **$H_a$ (Alternative Hypothesis):** $\beta_1 < 0$ and $\beta_2 > 0$.
    * We hypothesize that $\beta_1$ will be negative (younger players bet more).
    * We hypothesize that $\beta_2$ will be positive (male players bet more than female players).

---

### Why We Include $\beta_0$ and $\epsilon$ in the Multiple Regression Model (Hypothesis 2)

Understanding the roles of the constant ($\beta_0$) and the error term ($\epsilon$) is crucial for interpreting the multiple regression model (Hypothesis 2):

#### 1. The Role of $\beta_0$ (The Intercept)

Even when the literal interpretation of $\beta_0$ is meaningless (like predicting the stakes of a 0-year-old), the term is crucial for the mathematical integrity of the model.

* **It Anchors the Line:** $\beta_0$ allows the regression line (or plane) to be shifted up or down so that it passes through the mean of the data. Without it, the line would be forced to start at the origin (0, 0), which would almost certainly result in a terrible fit for the actual data points.
* **It Isolates the Effects of the Slopes:** In a multiple regression, the goal is to determine the effect of Age ($\beta_1$) and Gender ($\beta_2$) independently. $\beta_0$ absorbs the overall average stakes and ensures that the coefficients ($\beta_1$ and $\beta_2$) truly represent the change associated with their respective variables, rather than compensating for a general baseline value.

#### 2. The Role of $\epsilon$ (The Error Term)

The error term ($\epsilon$) is equally crucial because it acknowledges that our model is an imperfect representation of reality.

* **It Captures Missing Information:** $\epsilon$ represents all the variation in total stakes that is not explained by our chosen predictor variables (Age and Gender). This includes factors like individual luck, specific poker strategy, time spent online, or the player's emotional state.
* **It Satisfies Statistical Assumptions:** In linear regression, we must assume this $\epsilon$ (the difference between the actual stakes and the predicted stakes) is purely random noise and not systematically related to our predictor variables. This assumption is fundamental for calculating reliable $p$-values and confidence intervals, which we use to determine if the effects of our $\beta$ coefficients are statistically significant.
## 5\. Initial Insights

### Descriptive Statistics

```{r descriptive_stats}
# Player demographics summary
demo_summary <- demographics %>%
  summarise(
    N = n(),
    Mean_Age = mean(SystemAgeAsOfReg, na.rm = TRUE),
    SD_Age = sd(SystemAgeAsOfReg, na.rm = TRUE),
    Male_Pct = mean(Gender == "M") * 100
  )

kable(demo_summary, digits = 2,
      caption = "Demographics Summary",
      col.names = c("N Players", "Mean Age", "SD Age", "% Male"))

# Financial activity summary
fin_summary <- data.frame(
  Metric = c("Total Deposits", "Successful Deposits", "Total Withdrawals",
             "Successful Withdrawals", "Players with Withdrawals"),
  Value = c(
    nrow(deposits),
    sum(deposits$Status == "S"),
    nrow(withdrawals),
    sum(withdrawals$Status == "S"),
    length(unique(withdrawals$UserID[withdrawals$Status == "S"]))
  )
)
kable(fin_summary, caption = "Financial Activity Overview")
```

### Key Observations

```{r key_insights}
# Calculate key metrics
n_cash_players <- length(unique(cash_games$UserID))
n_tournament_players <- length(unique(tournaments$UserID))
n_withdrawal_players <- length(
  unique(withdrawals$UserID[withdrawals$Status == "S"])
)
withdrawal_rate <- round(
  n_withdrawal_players / nrow(demographics) * 100, 1
)
```

Preliminary exploration reveals several important patterns based on the dataset of 5,028 players:

  - Only **`r n_withdrawal_players`** of **`r nrow(demographics)`** players (**`r withdrawal_rate`%**) made successful withdrawals, suggesting many players experience net losses.
  - **`r n_cash_players`** players engaged in cash games, which tracks daily stakes and winnings.
  - The dataset shows high variability in betting amounts and player engagement levels.
  - Rich temporal structure (daily records from February 2015) allows for analysis of betting patterns over time.

### Exploratory Visualizations

```{r exploratory_plots, fig.width=10, fig.height=6}
# Age distribution
p1 <- ggplot(demographics, aes(x = SystemAgeAsOfReg)) +
  geom_histogram(binwidth = 5, fill = "steelblue", color = "white") +
  labs(title = "Player Age Distribution", x = "Age", y = "Count") +
  theme_minimal()

# Gender distribution
gender_counts <- demographics %>% count(Gender)
p2 <- ggplot(gender_counts, aes(x = Gender, y = n, fill = Gender)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), vjust = -0.5) +
  labs(title = "Gender Distribution", x = "Gender", y = "Count") +
  theme_minimal() +
  scale_fill_manual(values = c("F" = "#E69F00", "M" = "#56B4E9"))

# Prepare Data for Hypothesis Plots
# Aggregate stakes and bets by user
player_betting_volume <- cash_games %>%
  group_by(UserID) %>%
  summarise(
    Number_of_Bets = n(),
    Total_Stakes = sum(StakesC, na.rm = TRUE)
  ) %>%
  filter(
    Number_of_Bets >= 20,
    Total_Stakes > 50
  )

# Calculate median number of bets for grouping
median_bets <- median(player_betting_volume$Number_of_Bets, na.rm = TRUE)

# Join with demographics for Hypothesis 2
plot_data <- player_betting_volume %>%
  inner_join(demographics, by = "UserID")

# Trim outliers (5th-95th percentile) for cleaner visualization
bets_limits <- quantile(plot_data$Number_of_Bets, c(0.05, 0.95))
stakes_limits <- quantile(plot_data$Total_Stakes, c(0.05, 0.95))

trimmed_data <- plot_data %>%
  filter(
    Number_of_Bets >= bets_limits[1] &
      Number_of_Bets <= bets_limits[2],
    Total_Stakes >= stakes_limits[1] & Total_Stakes <= stakes_limits[2]
  ) %>%
  # NEW: Create frequency groups based on the pre-calculated median
  mutate(
      FrequencyGroup = ifelse(Number_of_Bets >= median_bets, "High-Frequency", "Low-Frequency")
  )


# Calculate summary statistics for Hypothesis 1 groups
h1_stats <- trimmed_data %>%
  group_by(FrequencyGroup) %>%
  summarise(
    Mean_Stakes = mean(Total_Stakes, na.rm = TRUE),
    Median_Stakes = median(Total_Stakes, na.rm = TRUE),
    SD_Stakes = sd(Total_Stakes, na.rm = TRUE),
    N = n()
  )

# Plot 3: Hypothesis 1 (T-Test visualization - Stakes by Group)
p3 <- ggplot(trimmed_data, aes(x = FrequencyGroup, y = Total_Stakes, fill = FrequencyGroup)) +
  geom_violin(alpha = 0.4, trim = FALSE) +
  geom_boxplot(width = 0.3, fill = "white", alpha = 0.8, outlier.alpha = 0.3) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 4, 
               fill = "red", color = "darkred", stroke = 1.5) +
  stat_summary(fun = mean, geom = "text", 
               aes(label = paste0("Mean: €", format(round(after_stat(y), 0), big.mark = ","))),
               vjust = -1.5, size = 3.5, fontface = "bold", color = "darkred") +
  scale_y_continuous(labels = scales::comma, 
                     breaks = seq(0, 150000, 25000),
                     limits = c(0, NA)) +
  scale_fill_manual(values = c("Low-Frequency" = "#E69F00", "High-Frequency" = "#56B4E9")) +
  labs(
    title = "Hypothesis 1: Total Stakes by Betting Frequency",
    subtitle = "Comparing mean stakes between High-Frequency and Low-Frequency bettors\nViolin shows distribution density | Box shows quartiles | Diamond shows mean",
    x = "Betting Frequency Group (Split by Median Bets)",
    y = "Total Stakes Wagered (€)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none",
    plot.subtitle = element_text(size = 9, color = "gray30"),
    axis.text.x = element_text(size = 11, face = "bold"),
    axis.title = element_text(size = 11, face = "bold")
  )

# Plot 4: Hypothesis 2 (Age + Gender vs Stakes)
# We plot Age vs Stakes, colored by Gender, with trend lines for each
p4 <- ggplot(trimmed_data, aes(x = SystemAgeAsOfReg, y = Total_Stakes, color = Gender)) +
  geom_point(alpha = 0.4, size = 1.5) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 1.2) +
  scale_color_manual(values = c("F" = "#E69F00", "M" = "#56B4E9")) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Hypothesis 2: Demographics vs. Stakes",
    subtitle = "Testing if Younger Men bet more",
    x = "Player Age",
    y = "Total Stakes Wagered (€)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

# Arrange plots
grid.arrange(p1, p2, ncol = 2)
grid.arrange(p3, p4, ncol = 2)
```

**Interpretation of Plot 3 (Hypothesis 1):**

```{r h1_interpretation}
kable(h1_stats, 
      digits = 0,
      format.args = list(big.mark = ","),
      caption = "Summary Statistics: Total Stakes by Betting Frequency",
      col.names = c("Group", "Mean Stakes (€)", "Median Stakes (€)", "SD Stakes (€)", "N Players"))
```

The visualization reveals several key patterns supporting our hypothesis:

* **Distribution Shape:** The violin plots show the probability density of stakes for each group. High-Frequency bettors have a wider distribution, indicating greater variability in betting amounts.

* **Central Tendency:** The red diamond marks the mean total stakes for each group. Visual inspection suggests High-Frequency bettors wager substantially more on average than Low-Frequency bettors.

* **Spread:** The box plots display quartiles (bottom, middle, and top of the box represent 25th, 50th, and 75th percentiles). The white boxes show that High-Frequency bettors have both higher medians and greater spread in their betting behavior.

* **Outliers:** Individual points outside the "whiskers" represent outliers. Both groups contain some extreme bettors, but High-Frequency bettors show more variability overall.

This visual pattern strongly suggests that betting frequency and total stakes are related, motivating our statistical test to determine if the difference in means is statistically significant.
