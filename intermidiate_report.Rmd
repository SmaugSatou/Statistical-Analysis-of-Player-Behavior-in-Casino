
---
title: "Statistical Analysis of Player Behaviour in Online Poker"
author: "Roman Prokhorov, Maksym Holovin, Nazar Pasichnyk"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE,
  fig.width = 8, fig.height = 5
)

# Install gridExtra if not already installed
if (!require("gridExtra", quietly = TRUE)) {
  install.packages("gridExtra", repos = "[https://cran.rstudio.com/](https://cran.rstudio.com/)")
}

library(ggplot2)
library(dplyr)
library(knitr)
library(gridExtra)
```

```{r load_data, include=FALSE}
# Load all datasets
demographics <- read.csv("csv/Demographics.csv")
cash_games <- read.csv("csv/CashGames.csv")
tournaments <- read.csv("csv/Tournaments.csv")
deposits <- read.csv("csv/Deposits.csv")
withdrawals <- read.csv("csv/Withdrawals.csv")

# Load country codes from ISO 3166-1 standard
raw_data <- read.csv(
  paste0(
    "https://raw.githubusercontent.com/lukes/",
    "ISO-3166-Countries-with-Regional-Codes/",
    "master/all/all.csv"
  ),
  stringsAsFactors = FALSE
)

# Create Nations lookup table
nations <- data.frame(
  Number = raw_data$country.code, NameEN = raw_data$name,
  Char2 = raw_data$alpha.2, Char3 = raw_data$alpha.3,
  stringsAsFactors = FALSE
)

# Apply GVC-specific corrections (as noted in data documentation)
nations$NameEN[nations$Number == 626] <- "East Timor"
nations$Char2[nations$Number == 626] <- "TP"
nations$Char3[nations$Number == 626] <- "TMP"
nations$Char3[nations$Number == 620] <- "POR"
nations$Char3[nations$Number == 642] <- "ROM"
nations$Char3[nations$Number == 756] <- "SUI"
nations$NameEN[nations$Number == 248] <- "Aland Islands"

# Add "Undefined" category
nations <- rbind(
  nations,
  data.frame(
    Number = 1000, NameEN = "Undefined",
    Char2 = "UD", Char3 = "UND",
    stringsAsFactors = FALSE
  )
)

# Merge country names with demographics
demographics <- demographics %>%
  left_join(nations, by = c("CountryID" = "Number")) %>%
  rename(Country = NameEN)
```

## 1\. Research Topic

We aim to analyze patterns in online poker player behavior using real transaction and gameplay data.
Our study will examine relationships between player demographics, betting patterns, and financial outcomes to understand
different player types and their gambling strategies.

## 2\. Data Source

**Source:** The Transparency Project (www.thetransparencyproject.org)

**Provider:** Division on Addiction, Cambridge Health Alliance, Harvard Medical School

**Dataset:** "Second Session at the Virtual Poker Table"

**Sample Size:** 5,028 online poker players who registered in February 2015

**Reference:** Tom, M. A., et al. (2022). Second Session at the Virtual Poker Table: A Contemporary Study of Actual Online Poker Activity. *Journal of Gambling Studies*. https://doi.org/10.1007/s10899-022-10147-1

## 3\. Data Description

The dataset consists of five interconnected CSV files:

  - **Demographics** (5,028 players): Age, Gender, Country of residence (encoded using ISO 3166-1 country codes)

  - **Cash Games** (51,763 daily records): Stakes wagered, winnings, number of sessions

  - **Tournaments** (82,831 daily records): Entry fees, prizes, number of tournaments

  - **Deposits** (295,119 transactions): Amount, payment method, transaction status

  - **Withdrawals** (32,307 transactions): Amount, payment method, transaction status

Key variables include player demographics, daily gambling activity (stakes and winnings),
and financial transactions (deposits and withdrawals in Euros). Country information is mapped from numeric ISO 3166-1 codes to country names for analysis.

### Sample Data Structure

```{r data_samples}
# Demographics sample - show with country names
kable(
  head(
    demographics[, c("UserID", "SystemAgeAsOfReg", "Gender", "Country")],
    5
  ),
  caption = "Demographics Sample (with Country Names)",
  col.names = c("User ID", "Age", "Gender", "Country")
)

# Deposits sample
kable(
  head(deposits[, c("UserID", "Amount", "Status", "PayMeth")], 5),
  caption = "Deposits Sample",
  col.names = c("User ID", "Amount (€)", "Status", "Payment Method")
)

# Cash Games sample
kable(
  head(cash_games, 5), caption = "Cash Games Sample",
  col.names = c("User ID", "Date", "Sessions", "Stakes (€)", "Winnings (€)")
)

# Top 10 countries by player count
top_countries <- demographics %>%
  filter(!is.na(Country)) %>%
  count(Country, sort = TRUE) %>%
  head(10)

kable(
  top_countries, caption = "Top 10 Countries by Player Count",
  col.names = c("Country", "Number of Players")
)
```


## 4. Preliminary Hypotheses (Revised $\beta_0$ Explanation)

### Hypothesis 1 (Linear Regression)
**Research Question:** Does the volume of betting activity (frequency) predict the total financial magnitude of the gambling?

We define $X$ as the number of bets placed and $Y$ as the total stakes wagered in cash games. The linear regression model is represented as:
$$Y = \beta_0 + \beta_1 X + \epsilon$$
Where:

* **$\beta_0$ (Y-Intercept):** Mathematically, this is the predicted total stakes for a player who places zero bets ($X=0$). **In this context, where all included players have placed bets, it primarily serves as a mathematical constant to anchor the regression line, not a meaningful predictor of real-world stakes.**

* **$\beta_1$ (Slope Coefficient):** The **expected change** in total stakes for every single additional bet placed. This is the **effect size** we are testing.

* **$\epsilon$ (Error Term):** The **unexplained variation** in total stakes that is not accounted for by the number of bets (e.g., luck, table limits, or unobserved factors).


* **$H_0$ (Null Hypothesis):** $\beta_1 = 0$. There is no linear relationship between the number of bets and total stakes.

* **$H_a$ (Alternative Hypothesis):** $\beta_1 \neq 0$. There is a significant linear relationship.

---

### Hypothesis 2 (Multiple Linear Regression)
**Research Question:** Do demographic characteristics (Age and Gender) predict the total amount a player wagers?

We define $Y$ as the Total Stakes Wagered, $X_1$ as Age, and $X_2$ as Gender (encoded as 0 for Female, 1 for Male). The model is:
$$Y = \beta_0 + \beta_1(Age) + \beta_2(Gender) + \epsilon$$
Where:

* **$\beta_0$ (Y-Intercept):** Mathematically, this is the predicted total stakes (€) when all predictor variables are zero (Age=0, Gender=0). **Since a 0-year-old cannot gamble, this term provides no practical interpretation and should be understood only as the necessary constant to align the fitted model with the observed data.**

* **$\beta_1$ (Age Coefficient):** The **change** in total stakes for every one-year increase in age, *holding gender constant*.

* **$\beta_2$ (Gender Coefficient):** The **difference** in total stakes between male players and the baseline female players (when controlling for age).

* **$\epsilon$ (Error Term):** The **unexplained variation** in total stakes not accounted for by Age and Gender.

* **$H_0$ (Null Hypothesis):** $\beta_1 = 0$ and $\beta_2 = 0$. Age and Gender have no linear relationship with total stakes wagered.
* **$H_a$ (Alternative Hypothesis):** $\beta_1 < 0$ and $\beta_2 > 0$.
    * We hypothesize that $\beta_1$ will be negative (younger players bet more).
    * We hypothesize that $\beta_2$ will be positive (male players bet more than female players).

---

### Why We Include $\beta_0$ and $\epsilon$ in the Model

Understanding the roles of the constant ($\beta_0$) and the error term ($\epsilon$) is crucial for interpreting the model:

#### 1. The Role of $\beta_0$ (The Intercept)

Even when the literal interpretation of $\beta_0$ is meaningless (like predicting the stakes of a 0-year-old), the term is crucial for the mathematical integrity of the model.

1.  **It Anchors the Line:** $\beta_0$ allows the regression line (or plane, in the case of multiple regression) to be shifted up or down so that it passes through the **mean** of the data. Without it, the line would be forced to start at the origin (0, 0), which would almost certainly result in a terrible fit for the actual data points.
2.  **It Isolates the Effects of the Slopes:** In a multiple regression (Hypothesis 2), the goal is to determine the effect of Age ($\beta_1$) and Gender ($\beta_2$) **independently**. $\beta_0$ absorbs the overall average stakes and ensures that the coefficients ($\beta_1$ and $\beta_2$) truly represent the *change* associated with their respective variables, rather than compensating for a general baseline value.

#### 2. The Role of $\epsilon$ (The Error Term)

The error term ($\epsilon$) is equally crucial because it acknowledges that our model is an **imperfect representation of reality**.

1.  **It Captures Missing Information:** $\epsilon$ represents all the variation in total stakes that is **not explained** by our chosen predictor variables (Age, Gender, or Number of Bets). This includes factors like individual luck, specific poker strategy, time spent online, or the player's emotional state.
2.  **It Satisfies Statistical Assumptions:** In linear regression, we must assume this $\epsilon$ (the difference between the actual stakes and the predicted stakes) is purely **random noise** and not systematically related to our predictor variables. This assumption is fundamental for calculating reliable $p$-values and confidence intervals, which we use to determine if the effects of our $\beta$ coefficients are statistically significant.

## 5\. Initial Insights

### Descriptive Statistics

```{r descriptive_stats}
# Player demographics summary
demo_summary <- demographics %>%
  summarise(
    N = n(),
    Mean_Age = mean(SystemAgeAsOfReg, na.rm = TRUE),
    SD_Age = sd(SystemAgeAsOfReg, na.rm = TRUE),
    Male_Pct = mean(Gender == "M") * 100
  )

kable(demo_summary, digits = 2,
      caption = "Demographics Summary",
      col.names = c("N Players", "Mean Age", "SD Age", "% Male"))

# Financial activity summary
fin_summary <- data.frame(
  Metric = c("Total Deposits", "Successful Deposits", "Total Withdrawals",
             "Successful Withdrawals", "Players with Withdrawals"),
  Value = c(
    nrow(deposits),
    sum(deposits$Status == "S"),
    nrow(withdrawals),
    sum(withdrawals$Status == "S"),
    length(unique(withdrawals$UserID[withdrawals$Status == "S"]))
  )
)
kable(fin_summary, caption = "Financial Activity Overview")
```

### Key Observations

```{r key_insights}
# Calculate key metrics
n_cash_players <- length(unique(cash_games$UserID))
n_tournament_players <- length(unique(tournaments$UserID))
n_withdrawal_players <- length(
  unique(withdrawals$UserID[withdrawals$Status == "S"])
)
withdrawal_rate <- round(
  n_withdrawal_players / nrow(demographics) * 100, 1
)
```

Preliminary exploration reveals several important patterns based on the dataset of 5,028 players:

  - Only **`r n_withdrawal_players`** of **`r nrow(demographics)`** players (**`r withdrawal_rate`%**) made successful withdrawals, suggesting many players experience net losses.
  - **`r n_cash_players`** players engaged in cash games, which tracks daily stakes and winnings.
  - The dataset shows high variability in betting amounts and player engagement levels.
  - Rich temporal structure (daily records from February 2015) allows for analysis of betting patterns over time.

### Exploratory Visualizations

```{r exploratory_plots, fig.width=10, fig.height=6}
# Age distribution
p1 <- ggplot(demographics, aes(x = SystemAgeAsOfReg)) +
  geom_histogram(binwidth = 5, fill = "steelblue", color = "white") +
  labs(title = "Player Age Distribution", x = "Age", y = "Count") +
  theme_minimal()

# Gender distribution
gender_counts <- demographics %>% count(Gender)
p2 <- ggplot(gender_counts, aes(x = Gender, y = n, fill = Gender)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), vjust = -0.5) +
  labs(title = "Gender Distribution", x = "Gender", y = "Count") +
  theme_minimal() +
  scale_fill_manual(values = c("F" = "#E69F00", "M" = "#56B4E9"))

# Prepare Data for Hypothesis Plots
# Aggregate stakes and bets by user
player_betting_volume <- cash_games %>%
  group_by(UserID) %>%
  summarise(
    Number_of_Bets = n(),
    Total_Stakes = sum(StakesC, na.rm = TRUE)
  ) %>%
  filter(
    Number_of_Bets >= 20,
    Total_Stakes > 50
  )

# Join with demographics for Hypothesis 2
plot_data <- player_betting_volume %>%
  inner_join(demographics, by = "UserID")

# Trim outliers (5th-95th percentile) for cleaner visualization
bets_limits <- quantile(plot_data$Number_of_Bets, c(0.05, 0.95))
stakes_limits <- quantile(plot_data$Total_Stakes, c(0.05, 0.95))

trimmed_data <- plot_data %>%
  filter(
    Number_of_Bets >= bets_limits[1] &
      Number_of_Bets <= bets_limits[2],
    Total_Stakes >= stakes_limits[1] & Total_Stakes <= stakes_limits[2]
  )

# Plot 3: Hypothesis 1 (Bets vs Stakes)
p3 <- ggplot(trimmed_data, aes(x = Number_of_Bets, y = Total_Stakes)) +
  geom_point(alpha = 0.4, color = "steelblue", size = 1.5) +
  geom_smooth(method = "lm", color = "red", se = TRUE, linewidth = 1) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Hypothesis 1: Bets vs. Total Stakes",
    subtitle = "Testing positive linear relationship",
    x = "Frequency (Number of Bets)",
    y = "Magnitude (Total Stakes €)"
  ) +
  theme_minimal()

# Plot 4: Hypothesis 2 (Age + Gender vs Stakes)
# We plot Age vs Stakes, colored by Gender, with trend lines for each
p4 <- ggplot(trimmed_data, aes(x = SystemAgeAsOfReg, y = Total_Stakes, color = Gender)) +
  geom_point(alpha = 0.4, size = 1.5) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 1.2) +
  scale_color_manual(values = c("F" = "#E69F00", "M" = "#56B4E9")) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Hypothesis 2: Demographics vs. Stakes",
    subtitle = "Testing if Younger Men bet more",
    x = "Player Age",
    y = "Total Stakes Wagered (€)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

# Arrange plots
grid.arrange(p1, p2, ncol = 2)
grid.arrange(p3, p4, ncol = 2)
```

These visualizations motivate our hypotheses and demonstrate interesting patterns in the data that warrant statistical testing. The relationship between number of bets and total stakes ($P3$) visually confirms a strong correlation, setting up our first linear regression. The demographic plot ($P4$) allows us to visually inspect the slopes for Age and Gender simultaneously; if our hypothesis is correct, we expect to see the regression lines trending downwards (higher stakes for lower age) and the "Male" line positioned higher than the "Female" line.
